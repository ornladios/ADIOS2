defaults: &defaults
  steps:
    - checkout:
        path: source
    - run:
        # https://discuss.circleci.com/t/circle-working-directory-doesnt-expand/17007
        name: "Fix CIRCLE_WORKING_DIRECTORY"
        command: echo 'CIRCLE_WORKING_DIRECTORY="${CIRCLE_WORKING_DIRECTORY/#\~/$HOME}"' >> $BASH_ENV
    - run:
        name: CDash
        command: bash source/scripts/ci/circle/postCDashStatus.sh
    - run:
        name: Update
        command: bash source/scripts/ci/circle/run.sh update
    - run:
        name: Configure
        command: bash source/scripts/ci/circle/run.sh configure
    - run:
        name: Build
        command: bash source/scripts/ci/circle/run.sh build
    - run:
        name: Sanitize
        command: bash source/scripts/ci/circle/run.sh memcheck

version: 2

jobs:
  "opensuse-tw-ubsan":
    <<: *defaults
    docker:
      - image: ghcr.io/ornladios/adios2:ci-opensuse-tw-ubsan
  "opensuse-tw-asan":
    <<: *defaults
    docker:
      - image: ghcr.io/ornladios/adios2:ci-opensuse-tw-asan
  "opensuse-tw-msan":
    <<: *defaults
    docker:
      - image: ghcr.io/ornladios/adios2:ci-opensuse-tw-msan
    resource_class: large
  "opensuse-tw-tsan":
    <<: *defaults
    docker:
      - image: ghcr.io/ornladios/adios2:ci-opensuse-tw-tsan

workflows:
  version: 2
  sanitizers:
    jobs:
      - "opensuse-tw-ubsan"
      - "opensuse-tw-asan"
      - "opensuse-tw-msan"
      - "opensuse-tw-tsan"
